# Tests for malformed/bad channel_announcement
include setup.incl

1. block: $BLOCK_102

2. connect: privkey=0000000000000000000000000000000000000000000000000000000000000003
3. expect-send: type=init
4. recv: type=init features= globalfeatures=

# Funding tx spending 16835ac8c154b616baac524163f41fb0c4f82c7b972ad35d4d6f18d854f6856b/1, feerate 253 to bitcoin privkeys 0000000000000000000000000000000000000000000000000000000000000010 and 0000000000000000000000000000000000000000000000000000000000000020
# txid 189c40b0728f382fe91c87270926584e48e0af3a6789f37454afee6c7560311d
5. block: height=103 n=1 tx=020000000001016b85f654d8186f4d5dd32a977b2cf8c4b01ff4634152acba16b654c1c85a83160100000000ffffffff01c5410f0000000000220020c46bf3d1686d6dbb2d9244f8f67b90370c5aa2747045f1aeccb77d8187117382024730440220798d96d5a057b5b7797988a855217f41af05ece3ba8278366e2f69763c72e785022065d5dd7eeddc0766ddf65557c92b9c52c301f23f94d2cf681860d32153e6ae1e012102d6a3c2d0cf7904ab6af54d7c959435a452b24a63194e1c4e7c337d3ebbb3017b00000000

    # Invalid `channel_announcement`: short_channel_id too young.
    # It's allowed (even encouraged!) to cache this, so we separate this
    # from the other tests.
    1. recv: type=channel_announcement
       node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       features=
       chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
       short_channel_id=103x1x0
       node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
       node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
       bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
       bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65

    # Invalid `channel_announcement`: short_channel_id *still* too young.
    1. block: height=104 n=4
    2. recv: type=channel_announcement
       node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
       features=
       chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
       short_channel_id=103x1x0
       node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
       node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
       bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
       bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65

    # This makes announcement otherwise acceptable.
    1. block: height=104 n=5

        # Invalid `channel_announcement`: bad node_signature_1.
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791b)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
        2. expect-error:
    
        # Invalid `channel_announcement`: bad node_signature_2.
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791b)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
        2. expect-error:
     
        # Invalid `channel_announcement`: bad bitcoin_signature_1.
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791b)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
        2. expect-error:
    
        # Invalid `channel_announcement`: bad bitcoin_signature_2.
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791b)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
        2. expect-error:
    
        # Ignored `channel_announcement`: bad chain_hash
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:4ad0946fa8c3996015dec325c4b0540299287427ec8d8313842ce6f8dc06791a)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf1889100
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
    
        # Invalid `channel_announcement`: short_channel_id DNE
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:31592d21e4e2bb642dd9af658ab9ba629322fc028682f1b2eeb9afd8dfbf5cb5)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:31592d21e4e2bb642dd9af658ab9ba629322fc028682f1b2eeb9afd8dfbf5cb5)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:31592d21e4e2bb642dd9af658ab9ba629322fc028682f1b2eeb9afd8dfbf5cb5)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:31592d21e4e2bb642dd9af658ab9ba629322fc028682f1b2eeb9afd8dfbf5cb5)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x5x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
    
        # Invalid `channel_announcement`: short_channel_id output DNE
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:ad0d16d5bcc1826294f8c316e801a95a4f3b1514fed0b9f38e0314ebcc0f2409)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:ad0d16d5bcc1826294f8c316e801a95a4f3b1514fed0b9f38e0314ebcc0f2409)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:ad0d16d5bcc1826294f8c316e801a95a4f3b1514fed0b9f38e0314ebcc0f2409)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000020:ad0d16d5bcc1826294f8c316e801a95a4f3b1514fed0b9f38e0314ebcc0f2409)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x1
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=03d30199d74fb5a22d47b6e054e2f378cedacffcb89904a61d75d0dbd407143e65
    
        # Invalid `channel_announcement`: short_channel_id tx does not match
        # (second bitcoin privkey is ...021 instead of ...020)
        1. recv: type=channel_announcement
           node_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000002:57b5c0c52e239a20200877037040492feb27a92d0184ac47c979e1ef5c0a0a4a)
           node_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000003:57b5c0c52e239a20200877037040492feb27a92d0184ac47c979e1ef5c0a0a4a)
           bitcoin_signature_1=SIG(0000000000000000000000000000000000000000000000000000000000000010:57b5c0c52e239a20200877037040492feb27a92d0184ac47c979e1ef5c0a0a4a)
           bitcoin_signature_2=SIG(0000000000000000000000000000000000000000000000000000000000000021:57b5c0c52e239a20200877037040492feb27a92d0184ac47c979e1ef5c0a0a4a)
           features=
           chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
           short_channel_id=103x1x0
           node_id_1=02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
           node_id_2=02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9
           bitcoin_key_1=03e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a
           bitcoin_key_2=021697ffa6fd9de627c077e3d2fe541084ce13300b0bec1146f95ae57f0d0bd6a5

# To test if it accepted one of those channel_announcements, give it
# the matching channel_update, which should make it broadcast.
6. connect: privkey=0000000000000000000000000000000000000000000000000000000000000004
7. recv: type=channel_update
   signature=SIG(0000000000000000000000000000000000000000000000000000000000000002:5133e0542731e0b4b70b4cb99f8fb7dab2e6658b5a5add8d9dfd1a8e2c549f95)
   chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
   short_channel_id=103x1x0
   timestamp=1565587763
   message_flags=0
   channel_flags=0
   cltv_expiry_delta=144
   htlc_minimum_msat=0
   fee_base_msat=1000
   fee_proportional_millionths=10
8. recv: type=channel_update
   signature=SIG(0000000000000000000000000000000000000000000000000000000000000002:2ce3390486bfbb1cd2a93022aa6a52e0453f819cc0f233bb7995f4b93bfd787e)
   chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
   short_channel_id=103x1x1
   timestamp=1565587763
   message_flags=0
   channel_flags=0
   cltv_expiry_delta=144
   htlc_minimum_msat=0
   fee_base_msat=1000
   fee_proportional_millionths=10
9. recv: type=channel_update
   signature=SIG(0000000000000000000000000000000000000000000000000000000000000002:85f489ae81c450943aa159c0013c4536c8a104b5419be6276e61e165956081e6)
   chain_hash=06226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
   short_channel_id=103x5x0
   timestamp=1565587763
   message_flags=0
   channel_flags=0
   cltv_expiry_delta=144
   htlc_minimum_msat=0
   fee_base_msat=1000
   fee_proportional_millionths=10

# New peer connects, asking for initial_routing_sync.  We *won't* relay channel_announcement.
10. connect: privkey=0000000000000000000000000000000000000000000000000000000000000005
11. expect-send: type=init
12. recv: type=init features=08 globalfeatures=
13. must-not-send: type=channel_announcement
14. must-not-send: type=channel_update
