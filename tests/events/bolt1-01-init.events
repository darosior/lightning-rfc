# Variations on init exchange.
# Spec: MUST respond to known feature bits as specified in [BOLT #9](09-features.md).

# Trivial variable to serve as a demonstration
EXPECT_INIT=expect-send: type=init

1. connect: privkey=0000000000000000000000000000000000000000000000000000000000000003
2. $EXPECT_INIT
3. recv: type=init globalfeatures= features=

    1. nothing
    1. disconnect:

4. connect: privkey=0000000000000000000000000000000000000000000000000000000000000002
    # Even if we don't send anything, it should send init.
    1. $EXPECT_INIT

    # Minimal possible init message.
    # Spec: MUST send `init` as the first Lightning message for any connection.
    1. $EXPECT_INIT
    2. recv: type=init globalfeatures= features=

    # SHOULD NOT set features greater than 13 in `globalfeatures`.
    1. $EXPECT_INIT globalfeatures=000000/030000
    # init msg with unknown odd global bit (19): no error
    2. recv: type=init globalfeatures=020000 features=
    
    # Sanity check that bits 34 and 35 are not used!
    1. $EXPECT_INIT features=0000000000/0300000000
    # init msg with unknown odd local bit (19): no error
    2. recv: type=init globalfeatures= features=020000

    # init msg with unknown even global bit (34): you will error
    1. $EXPECT_INIT
    2. recv: type=init globalfeatures=0100000000 features=
    3. expect-error:

    # init msg with unknown even local bit (34): you will error
    1. $EXPECT_INIT
    2. recv: type=init globalfeatures= features=0100000000
    3. expect-error:

    # If you don't support `option_data_loss_protect`, you will be ok if
    # we ask for it.
    1. $EXPECT_INIT features=00/03 !option_data_loss_protect
    2. recv: type=init globalfeatures= features=02 !option_data_loss_protect

    # If you don't support `option_data_loss_protect`, you will error if
    # we require it.
    1. $EXPECT_INIT features=00/03 !option_data_loss_protect
    2. recv: type=init globalfeatures= features=01 !option_data_loss_protect
    3. expect-error: !option_data_loss_protect

    # If you support `option_data_loss_protect`, you will advertize it odd.
    1. $EXPECT_INIT features=02/03 option_data_loss_protect/odd

    # If you require `option_data_loss_protect`, you will advertize it even.
    1. $EXPECT_INIT features=01/03 option_data_loss_protect/even

    # If you don't support `option_static_remotekey`, you will be ok if
    # we ask for it.
    1. $EXPECT_INIT features=0000/3000 !option_static_remotekey
    2. recv: type=init globalfeatures= features=2000 !option_static_remotekey

    # If you don't support `option_static_remotekey`, you will error if
    # we require it.
    1. $EXPECT_INIT features=0000/3000 !option_static_remotekey
    2. recv: type=init globalfeatures= features=1000 !option_static_remotekey
    3. expect-error: !option_static_remotekey

    # If you support `option_static_remotekey`, you will advertize it odd.
    1. $EXPECT_INIT features=2000/3000 option_static_remotekey/odd

    # If you require `option_static_remotekey`, you will advertize it even.
    1. $EXPECT_INIT features=1000/3000 option_static_remotekey/even

    # The init message contains the network `chain_hash`
    1. $EXPECT_INIT tlvs=012006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
    # Sending the correct `chain_hash`: no error
    2. recv: type=init globalfeatures=020000 features=2000 tlvs=012006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f

    1. $EXPECT_INIT tlvs=012006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
    # Sending the correct `chain_hash` as part of an array with unknown `chain_hash`s: no error
    2. recv: type=init globalfeatures= features= tlvs=014006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f6fe28c0ab6f1b372c1a6a246ae63f74f931e8365e15a089c68d6190000000000

    # Wrong `chain_hash`, and only one provided: error
    1. $EXPECT_INIT tlvs=012006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
    2. recv: type=init globalfeatures=020000 features=2000 tlvs=01206fe28c0ab6f1b372c1a6a246ae63f74f931e8365e15a089c68d6190000000000
    3. expect-error:

    # Many `chain_hash` provided, but no common one : error
    1. $EXPECT_INIT tlvs=012006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f
    2. recv: type=init globalfeatures=020000 features=2000 tlvs=01406fe28c0ab6f1b372c1a6a246ae63f74f931e8365e15a089c68d61900000000005fe28c0ab6f1b372c1a6a246ae63f74f931e8365e15a089c68d6190000000000
    3. expect-error:

    # Note: it's undefined what you'll do if implementation requires
    # an option and isn't offered it.  The recipient of the required feature
    # bit should notice the requirement and error.
